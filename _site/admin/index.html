<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <link rel="cms-config-url" href="config.yml" type="text/yaml">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    #nc-root {
      height: 100vh;
    }
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      flex-direction: column;
    }
    .error {
      padding: 20px;
      color: #d32f2f;
      max-width: 600px;
      margin: 0 auto;
    }
    .error pre {
      background: #f5f5f5;
      padding: 10px;
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="nc-root">
    <div class="loading">
      <p>Loading Decap CMS...</p>
    </div>
  </div>
  <script>
    // Ensure trailing slash for proper routing
    if (window.location.pathname !== '/admin/') {
      window.history.replaceState(null, null, '/admin/');
    }
    
    // Try multiple CDN sources
    const cdnSources = [
      'https://unpkg.com/decap-cms@^3/dist/decap-cms.js',
      'https://cdn.jsdelivr.net/npm/decap-cms@^3/dist/decap-cms.js',
      'https://unpkg.com/decap-cms@3.0.0/dist/decap-cms.js'
    ];
    
    let currentCDN = 0;
    const diagnostics = {
      scriptLoaded: false,
      cmsObject: null,
      configLoaded: false,
      errors: [],
      cdnUsed: null
    };
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.async = true;
        
        script.onload = () => {
          diagnostics.scriptLoaded = true;
          diagnostics.cdnUsed = src;
          console.log('Script loaded from:', src);
          
          // Check for CMS object after a short delay
          setTimeout(() => {
            if (typeof window.CMS !== 'undefined') {
              diagnostics.cmsObject = 'window.CMS';
              console.log('Found window.CMS');
            } else if (typeof window.DecapCMS !== 'undefined') {
              diagnostics.cmsObject = 'window.DecapCMS';
              console.log('Found window.DecapCMS');
            } else {
              console.warn('CMS object not found after script load');
            }
          }, 500);
          
          resolve();
        };
        
        script.onerror = () => {
          console.error('Failed to load from:', src);
          reject(new Error(`Failed to load from ${src}`));
        };
        
        document.head.appendChild(script);
      });
    }
    
    // Try loading from CDNs in sequence
    async function tryLoadCMS() {
      for (let i = 0; i < cdnSources.length; i++) {
        try {
          await loadScript(cdnSources[i]);
          break; // Success, stop trying
        } catch (err) {
          diagnostics.errors.push(`CDN ${i + 1} failed: ${cdnSources[i]}`);
          if (i === cdnSources.length - 1) {
            // All CDNs failed
            showError();
          }
        }
      }
    }
    
    // Check config file
    fetch('config.yml')
      .then(r => {
        if (r.ok) {
          diagnostics.configLoaded = true;
          console.log('Config file loaded successfully');
        } else {
          diagnostics.errors.push(`Config file returned status ${r.status}`);
          console.error('Config file error:', r.status);
        }
      })
      .catch(err => {
        diagnostics.errors.push(`Config fetch error: ${err.message}`);
        console.error('Config fetch error:', err);
      });
    
    function showError() {
      const root = document.getElementById('nc-root');
      let errorHTML = '<div class="error"><h1>Decap CMS Failed to Load</h1>';
      errorHTML += '<h2>Diagnostics:</h2><ul>';
      errorHTML += `<li>Script loaded: ${diagnostics.scriptLoaded ? 'Yes' : 'No'}</li>`;
      errorHTML += `<li>CMS object found: ${diagnostics.cmsObject || 'No'}</li>`;
      errorHTML += `<li>Config loaded: ${diagnostics.configLoaded ? 'Yes' : 'No'}</li>`;
      if (diagnostics.cdnUsed) {
        errorHTML += `<li>CDN used: ${diagnostics.cdnUsed}</li>`;
      }
      errorHTML += '</ul>';
      
      if (diagnostics.errors.length > 0) {
        errorHTML += '<h2>Errors:</h2><ul>';
        diagnostics.errors.forEach(err => {
          errorHTML += `<li>${err}</li>`;
        });
        errorHTML += '</ul>';
      }
      
      errorHTML += '<h2>Possible Solutions:</h2><ul>';
      errorHTML += '<li>Check if ad blocker is blocking the CDN scripts</li>';
      errorHTML += '<li>Check browser console (F12) for CORS or network errors</li>';
      errorHTML += '<li>Check Network tab to see which CDN requests are failing</li>';
      errorHTML += '<li>Try disabling browser extensions temporarily</li>';
      errorHTML += '<li>Check if your network/firewall is blocking unpkg.com or jsdelivr.net</li>';
      errorHTML += '</ul>';
      errorHTML += '</div>';
      
      root.innerHTML = errorHTML;
    }
    
    // Start loading
    tryLoadCMS();
    
    // Final check after delay
    setTimeout(function() {
      const root = document.getElementById('nc-root');
      const hasCMS = typeof window.CMS !== 'undefined' || typeof window.DecapCMS !== 'undefined';
      
      if (!hasCMS && !diagnostics.scriptLoaded) {
        showError();
      } else if (hasCMS) {
        // Remove loading message - CMS should render
        if (root.querySelector('.loading')) {
          root.querySelector('.loading').remove();
        }
        console.log('CMS should be initializing...');
      }
    }, 5000);
  </script>
</body>
</html>